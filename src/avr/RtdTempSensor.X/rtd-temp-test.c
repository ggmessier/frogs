/*
 * File:   rtd-temp-test.c
 * Author: gmessier
 *
 * Created on January 14, 2024, 12:40 PM
 */


#include <avr/io.h>
#include <stdio.h>
#include "../lib-Avr128DbX.X/lib-avr.h"


uint16_t rtdAdcToTemp[2][201] = {
  { 543, 544, 544, 544, 545, 545, 545, 546, 546, 547, 547, 547, 548, 548, 548, 549, 549, 550, 550, 550, 551, 551, 552, 552, 553, 553, 554, 554, 554, 555, 555, 556, 556, 557, 557, 558, 558, 559, 559, 560, 560, 561, 561, 562, 562, 563, 563, 564, 564, 565, 566, 566, 567, 567, 568, 568, 569, 570, 570, 571, 571, 572, 573, 573, 574, 574, 575, 576, 576, 577, 577, 578, 579, 579, 580, 581, 581, 582, 583, 583, 584, 585, 585, 586, 587, 588, 588, 589, 590, 590, 591, 592, 593, 593, 594, 595, 595, 596, 597, 598, 599, 599, 600, 601, 602, 602, 603, 604, 605, 606, 606, 607, 608, 609, 610, 610, 611, 612, 613, 614, 615, 615, 616, 617, 618, 619, 620, 621, 622, 622, 623, 624, 625, 626, 627, 628, 629, 630, 631, 631, 632, 633, 634, 635, 636, 637, 638, 639, 640, 641, 642, 643, 644, 645, 646, 647, 648, 649, 650, 651, 652, 653, 654, 655, 656, 657, 658, 659, 660, 661, 662, 663, 664, 665, 666, 668, 669, 670, 671, 672, 673, 674, 675, 676, 677, 679, 680, 681, 682, 683, 684, 685, 686, 688, 689, 690, 691, 692, 693, 695, 696 },
  { -100, -99, -98, -97, -96, -95, -94, -93, -92, -91, -90, -89, -88, -87, -86, -85, -84, -83, -82, -81, -80, -79, -78, -77, -76, -75, -74, -73, -72, -71, -70, -69, -68, -67, -66, -65, -64, -63, -62, -61, -60, -59, -58, -57, -56, -55, -54, -53, -52, -51, -50, -49, -48, -47, -46, -45, -44, -43, -42, -41, -40, -39, -38, -37, -36, -35, -34, -33, -32, -31, -30, -29, -28, -27, -26, -25, -24, -23, -22, -21, -20, -19, -18, -17, -16, -15, -14, -13, -12, -11, -10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100 }
};


#define NSAMPLE_ACC_LOG2 5

int main(void) {
  
  // Use the internal 32.768kHz oscillator.
  CCP = 0xd8;
  CLKCTRL.MCLKCTRLA = 0x01;
  while( CLKCTRL.MCLKSTATUS & 0b00000001 ){
    ;
  }
  

  USART0.BAUD = 0x006d;
  USART0.CTRLA = 0b00100000;
  USART0.CTRLC = 0b00000011;
  PORTA.DIRSET = 0b00000001;
  USART0.CTRLB = 0b11000010;
  
  RTD_SENSOR_OPAMP0_CONFIG;
  RTD_SENSOR_ADC_CONFIG;
  
  
  /* Replace with your application code */
  char str[100];
  uint16_t res;
  uint8_t tIdx,tIntVal;
  char tFrac[2] = { '0', '5' };
  while (1) {
  
    RTD_SENSOR_READ_ENABLE;
    res = ADC0.RES >> NSAMPLE_ACC_LOG2;
    //RTD_SENSOR_READ_DISABLE;
    
    for(tIdx=0; rtdAdcToTemp[0][tIdx] < res; tIdx++) ;
    tIntVal = rtdAdcToTemp[1][tIdx] >> 1;
    char tFracChar = tFrac[ rtdAdcToTemp[1][tIdx] & 0x0001 ];

    sprintf(str,"Temp: %d.%cC, ADC: %d\n\r",tIntVal,tFracChar,res);
    USART_PRINT_STR(str);
    
    
    
  }
}

/*
void read_adc(){
  
  ADC0.CTRLA |= 0b00000001;  // Enable ADC
  
  ADC0.INTFLAGS |= 0b00000001;  // Wait for sample.
  while( (ADC0.INTFLAGS & 0b00000001) == 0 ) ;  
  ADC0.INTFLAGS |= 0b00000001;
  
  ADC0.CTRLA &= 0b11111110;  // Disable ADC
  
  
  
}
*/
